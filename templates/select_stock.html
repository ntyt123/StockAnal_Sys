{% extends "layout.html" %} {% block title %}辅助选股 - 辅助选股分析系统{% endblock %} {% block content %}
<div class="finance-portal-container">
  <div id="alerts-container"></div>

  <!-- 左侧导航栏 -->
  <div class="portal-sidebar">
    <div class="sidebar-menu">
      <div class="sidebar-header">
        <h5><i class="fas fa-th-list"></i> 功能导航</h5>
      </div>
      <div class="sidebar-content">
        <ul class="sidebar-nav">
          <li>
            <a href="#" class="nav-link active" data-interface="condition-select-interface">
              <i class="fas fa-table"></i> 条件选股
            </a>
          </li>
          <li>
            <a href="#" class="nav-link" data-interface="ai-select-interface"> <i class="fas fa-brain"></i> AI选股 </a>
          </li>
          <li>
            <a href="#" class="nav-link" data-interface="history-compare-interface">
              <i class="fas fa-history"></i> 历史选股对比
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="portal-center">
    <!-- 条件选股界面 -->
    <div id="condition-select-interface" class="interface-content">
      <div class="interface-header">
        <h5><i class="fas fa-filter"></i> 条件选股</h5>
        <div class="interface-tools">
          <!-- 数据状态显示 -->
          <div class="data-status me-3">
            <span class="badge bg-info" id="stock-data-status"> <i class="fas fa-database"></i> 检查数据状态... </span>
          </div>
          <!-- 强制获取新数据按钮 -->
          <button class="btn btn-sm btn-outline-info me-2" id="force-refresh-data-btn">
            <i class="fas fa-sync-alt"></i> 强制获取新数据
          </button>
          <!-- 手动下载按钮 -->
          <button class="btn btn-sm btn-outline-warning me-2" id="manual-download-btn" style="display: none">
            <i class="fas fa-download"></i> 下载股票数据
          </button>
          <button class="btn btn-sm btn-outline-success" id="save-strategy-btn">
            <i class="fas fa-save"></i> 保存策略
          </button>
          <button class="btn btn-sm btn-outline-primary" id="load-strategy-btn">
            <i class="fas fa-folder-open"></i> 加载策略
          </button>
        </div>
      </div>
      <div class="interface-body">
        <form id="stock-filter-form" class="row g-3">
          <!-- 基础筛选条件 -->
          <div class="col-md-6">
            <label class="form-label">市场类型</label>
            <select class="form-select" id="market-type">
              <option value="A" selected>A股</option>
              <option value="HK">港股</option>
              <option value="US">美股</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">行业板块</label>
            <select class="form-select" id="industry-sector">
              <option value="">全部行业</option>
              <option value="科技">科技</option>
              <option value="医药">医药</option>
              <option value="消费">消费</option>
              <option value="金融">金融</option>
              <option value="地产">地产</option>
              <option value="能源">能源</option>
              <option value="制造">制造</option>
              <option value="农业">农业</option>
            </select>
          </div>

          <!-- 技术指标筛选 -->
          <div class="col-md-4">
            <label class="form-label">RSI指标</label>
            <select class="form-select" id="rsi-filter">
              <option value="">不限</option>
              <option value="oversold">超卖 (< 30)</option>
              <option value="neutral">中性 (30-70)</option>
              <option value="overbought">超买 (> 70)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">MACD信号</label>
            <select class="form-select" id="macd-filter">
              <option value="">不限</option>
              <option value="golden_cross">金叉信号</option>
              <option value="death_cross">死叉信号</option>
              <option value="positive">MACD > 0</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">成交量</label>
            <select class="form-select" id="volume-filter">
              <option value="">不限</option>
              <option value="high">放量 (> 2倍平均)</option>
              <option value="low">缩量 (< 0.5倍平均)</option>
            </select>
          </div>

          <!-- 基本面筛选 -->
          <div class="col-md-4">
            <label class="form-label">市盈率(PE)</label>
            <select class="form-select" id="pe-filter">
              <option value="">不限</option>
              <option value="low">低估值 (< 15)</option>
              <option value="medium">合理 (15-30)</option>
              <option value="high">高估值 (> 30)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">市净率(PB)</label>
            <select class="form-select" id="pb-filter">
              <option value="">不限</option>
              <option value="low">低估值 (< 1.5)</option>
              <option value="medium">合理 (1.5-3)</option>
              <option value="high">高估值 (> 3)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">ROE</label>
            <select class="form-select" id="roe-filter">
              <option value="">不限</option>
              <option value="high">高ROE (> 15%)</option>
              <option value="medium">中等ROE (8-15%)</option>
              <option value="low">低ROE (< 8%)</option>
            </select>
          </div>

          <!-- 操作按钮 -->
          <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary btn-lg me-3"><i class="fas fa-search"></i> 开始筛选</button>
            <button type="button" class="btn btn-secondary btn-lg me-3" id="reset-filters">
              <i class="fas fa-redo"></i> 重置条件
            </button>
            <button type="button" class="btn btn-info btn-lg" id="preview-strategy">
              <i class="fas fa-eye"></i> 预览策略
            </button>
          </div>
        </form>

        <!-- 筛选结果 -->
        <div id="filter-results" class="mt-4" style="display: none">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="fas fa-list"></i> 筛选结果</h6>
              <div>
                <span class="badge bg-primary me-2" id="result-count">0</span>
                <button class="btn btn-sm btn-outline-primary" id="export-results">
                  <i class="fas fa-download"></i> 导出
                </button>
              </div>
            </div>
            <div class="card-body p-2">
              <div class="alert alert-info alert-sm mb-0">
                <i class="fas fa-info-circle"></i>
                <small
                  >数据来源：数据库中的A股基础信息 + 模拟技术指标数据 | 获取时间：<span id="data-update-time"
                    >--</span
                  ></small
                >
              </div>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>代码</th>
                      <th>名称</th>
                      <th>行业</th>
                      <th>现价</th>
                      <th>涨跌幅</th>
                      <th>评分</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="results-tbody">
                    <!-- 结果将在这里动态生成 -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AI选股界面 -->
    <div id="ai-select-interface" class="interface-content" style="display: none">
      <div class="interface-header">
        <h5><i class="fas fa-brain"></i> AI智能选股</h5>
        <div class="interface-tools">
          <button class="btn btn-sm btn-outline-info" id="ai-settings-btn"><i class="fas fa-cog"></i> AI设置</button>
        </div>
      </div>
      <div class="interface-body">
        <div class="text-center py-5">
          <i class="fas fa-robot fa-3x text-primary mb-3"></i>
          <h5>AI智能选股</h5>
          <p class="text-muted">基于机器学习和市场数据分析，为您推荐优质股票</p>
          <button class="btn btn-primary btn-lg" id="start-ai-select"><i class="fas fa-play"></i> 开始AI选股</button>
        </div>
      </div>
    </div>

    <!-- 历史选股对比界面 -->
    <div id="history-compare-interface" class="interface-content" style="display: none">
      <div class="interface-header">
        <h5><i class="fas fa-history"></i> 历史选股对比</h5>
        <div class="interface-tools">
          <button class="btn btn-sm btn-outline-warning" id="clear-history-btn">
            <i class="fas fa-trash"></i> 清空历史
          </button>
        </div>
      </div>
      <div class="interface-body">
        <div class="text-center py-5">
          <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
          <h5>历史选股对比</h5>
          <p class="text-muted">查看和分析历史选股策略的表现</p>
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body text-center">
                  <h6>成功率</h6>
                  <h3 class="text-success">78%</h3>
                  <small class="text-muted">近30天</small>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body text-center">
                  <h6>平均收益</h6>
                  <h3 class="text-primary">+12.5%</h3>
                  <small class="text-muted">近30天</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 右侧股票详情区域 -->
  <div class="portal-hotspot">
    <div class="hotspot-header">
      <h5><i class="fas fa-chart-line"></i> 股票详情</h5>
      <div class="stock-tools">
        <button class="btn btn-sm btn-outline-primary" id="refresh-stock-info">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
    </div>
    <div class="hotspot-content" id="stock-detail-panel">
      <!-- 默认状态 -->
      <div class="text-center py-5" id="default-stock-panel">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h6 class="text-muted">请选择一只股票查看详情</h6>
        <p class="text-muted small">从筛选结果中选择股票或直接输入股票代码</p>
        <div class="input-group input-group-sm mt-3">
          <input type="text" class="form-control" id="quick-stock-input" placeholder="输入股票代码" />
          <button class="btn btn-outline-primary" type="button" id="quick-stock-search">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>

      <!-- 股票详情内容 -->
      <div id="stock-detail-content" style="display: none">
        <!-- 基本信息 -->
        <div class="stock-basic-info mb-3">
          <div class="d-flex align-items-center mb-2">
            <h6 class="mb-0" id="detail-stock-name">--</h6>
            <span class="badge bg-secondary ms-2" id="detail-stock-code">--</span>
          </div>
          <div class="stock-price-info">
            <div class="current-price">
              <span class="price-label">现价:</span>
              <span class="price-value" id="detail-stock-price">--</span>
            </div>
            <div class="price-change">
              <span class="change-value" id="detail-stock-change">--</span>
              <span class="change-percent" id="detail-stock-change-percent">--</span>
            </div>
          </div>
        </div>

        <!-- 技术指标 -->
        <div class="stock-technical mb-3">
          <h6 class="section-title">技术指标</h6>
          <div class="row g-2">
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">RSI:</span>
                <span class="indicator-value" id="detail-rsi">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">MACD:</span>
                <span class="indicator-value" id="detail-macd">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">KDJ:</span>
                <span class="indicator-value" id="detail-kdj">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">成交量:</span>
                <span class="indicator-value" id="detail-volume">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 基本面数据 -->
        <div class="stock-fundamental mb-3">
          <h6 class="section-title">基本面数据</h6>
          <div class="row g-2">
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">PE:</span>
                <span class="indicator-value" id="detail-pe">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">PB:</span>
                <span class="indicator-value" id="detail-pb">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">ROE:</span>
                <span class="indicator-value" id="detail-roe">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="indicator-item">
                <span class="indicator-label">市值:</span>
                <span class="indicator-value" id="detail-market-cap">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 支撑压力位 -->
        <div class="stock-support-resistance mb-3">
          <h6 class="section-title">支撑压力位</h6>
          <div class="row g-2">
            <div class="col-6">
              <div class="level-item support">
                <span class="level-label">支撑位:</span>
                <span class="level-value" id="detail-support">--</span>
              </div>
            </div>
            <div class="col-6">
              <div class="level-item resistance">
                <span class="level-label">压力位:</span>
                <span class="level-value" id="detail-resistance">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="stock-actions">
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-outline-primary" id="view-full-detail">
              <i class="fas fa-external-link-alt"></i> 查看完整详情
            </button>
            <button class="btn btn-sm btn-outline-success" id="add-to-watchlist">
              <i class="fas fa-plus"></i> 添加到自选股
            </button>
            <button class="btn btn-sm btn-outline-info" id="start-ai-analysis">
              <i class="fas fa-brain"></i> AI分析
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-panel" class="text-center py-5" style="display: none">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 mb-0">正在获取选择的股票数据...</p>
  </div>
</div>
{% endblock %} {% block head %}
<style>
  /* 界面切换样式 */
  .interface-content {
    display: none;
  }

  .interface-content.active {
    display: block;
  }

  /* 默认显示条件选股界面 */
  #condition-select-interface {
    display: block !important;
  }

  /* 修复布局问题 - 确保三个区域并排显示 */
  .finance-portal-container {
    display: grid;
    grid-template-columns: 250px 1fr 300px;
    grid-template-rows: 1fr;
    grid-template-areas: 'sidebar center right';
    height: calc(100vh - 56px);
    overflow: hidden;
    gap: 15px;
    padding: 15px;
    background-color: #f5f7fa;
  }

  .portal-sidebar {
    grid-area: sidebar;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
    padding: 15px;
  }

  .portal-center {
    grid-area: center;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
  }

  .portal-hotspot {
    grid-area: right;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
  }

  /* 响应式调整 */
  @media (max-width: 1200px) {
    .finance-portal-container {
      grid-template-columns: 200px 1fr 250px;
    }
  }

  @media (max-width: 992px) {
    .finance-portal-container {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto;
      grid-template-areas:
        'sidebar'
        'center'
        'right';
      height: auto;
      overflow: auto;
    }

    .portal-sidebar,
    .portal-center,
    .portal-hotspot {
      height: auto;
      min-height: 400px;
    }
  }

  .interface-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    background-color: #fff;
  }

  .interface-header h5 {
    margin: 0;
    color: #333;
    font-size: 18px;
  }

  .interface-tools {
    display: flex;
    gap: 10px;
  }

  .interface-body {
    padding: 20px;
    background-color: #fff;
    min-height: 400px;
    overflow-y: auto;
  }

  /* 侧边栏导航样式 */
  .sidebar-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar-nav li {
    margin-bottom: 5px;
  }

  .sidebar-nav .nav-link {
    display: block;
    padding: 10px 15px;
    color: #666;
    text-decoration: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .sidebar-nav .nav-link:hover {
    background-color: #f0f5ff;
    color: #1a73e8;
  }

  .sidebar-nav .nav-link.active {
    background-color: #e3f2fd;
    color: #1976d2;
    border-left: 3px solid #1976d2;
  }

  .sidebar-nav i {
    width: 20px;
    margin-right: 8px;
    text-align: center;
  }

  /* 表单样式优化 */
  .form-label {
    font-weight: 500;
    color: #555;
  }

  .form-select {
    border-radius: 6px;
    border: 1px solid #ddd;
  }

  .form-select:focus {
    border-color: #1976d2;
    box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
  }

  /* 按钮样式 */
  .btn-lg {
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
  }

  /* 结果表格样式 */
  .table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
    color: #495057;
  }

  .table td {
    vertical-align: middle;
  }

  /* 卡片样式 */
  .card {
    border: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
  }

  .card-header {
    background-color: #fff;
    border-bottom: 1px solid #eee;
  }

  /* 响应式调整 */
  @media (max-width: 768px) {
    .interface-header {
      flex-direction: column;
      gap: 15px;
      align-items: flex-start;
    }

    .interface-tools {
      width: 100%;
      justify-content: space-between;
    }
  }

  .chat-message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
  }

  .user-message {
    align-items: flex-end;
  }

  .system-message {
    align-items: flex-start;
  }

  .message-content {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 15px;
    position: relative;
  }

  .user-message .message-content {
    background-color: #007bff;
    color: white;
    border-bottom-right-radius: 0;
  }

  .system-message .message-content {
    background-color: #f1f1f1;
    color: #333;
    border-bottom-left-radius: 0;
  }

  .message-content p {
    margin-bottom: 0.5rem;
  }

  .message-content p:last-child {
    margin-bottom: 0;
  }

  .message-time {
    font-size: 0.75rem;
    color: #aaa;
    margin-top: 4px;
  }

  .common-question {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
  }

  .keyword {
    color: #2c7be5;
    font-weight: 600;
  }

  .term {
    color: #d6336c;
    font-weight: 500;
    padding: 0 2px;
  }

  .price {
    color: #00a47c;
    font-family: 'Roboto Mono', monospace;
    background: #f3faf8;
    padding: 2px 4px;
    border-radius: 3px;
  }

  .trend-up {
    color: #28a745;
  }

  .trend-down {
    color: #dc3545;
  }

  /* 右侧股票详情面板样式 */
  .stock-tools {
    display: flex;
    gap: 8px;
  }

  .stock-basic-info {
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .stock-basic-info h6 {
    color: white;
    font-weight: 600;
  }

  .stock-price-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
  }

  .current-price .price-label {
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .current-price .price-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-left: 8px;
  }

  .price-change {
    text-align: right;
  }

  .change-value {
    display: block;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .change-percent {
    display: block;
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .section-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #e9ecef;
  }

  .indicator-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .indicator-label {
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
  }

  .indicator-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
  }

  .level-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .level-item.support {
    background-color: #d4edda;
    border-left: 4px solid #28a745;
  }

  .level-item.resistance {
    background-color: #f8d7da;
    border-left: 4px solid #dc3545;
  }

  .level-label {
    font-size: 0.85rem;
    font-weight: 500;
  }

  .level-value {
    font-size: 0.9rem;
    font-weight: 600;
  }

  .support .level-label {
    color: #155724;
  }

  .support .level-value {
    color: #155724;
  }

  .resistance .level-label {
    color: #721c24;
  }

  .resistance .level-value {
    color: #721c24;
  }

  .stock-actions {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
  }

  .stock-actions .btn {
    font-size: 0.85rem;
    padding: 8px 12px;
  }

  /* 响应式调整 */
  @media (max-width: 1200px) {
    .stock-price-info {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .price-change {
      text-align: left;
    }
  }
</style>
{% endblock %} {% block scripts %}
<script>
  let selectedStock = {
    code: '',
    name: '',
    market_type: 'A',
  };

  $(document).ready(function () {
    // 默认显示条件选股界面
    showInterface('condition-select-interface');

    // 确保条件选股界面可见
    $('#condition-select-interface').show();

    // 侧边栏导航点击事件
    $('.sidebar-nav .nav-link').on('click', function (e) {
      e.preventDefault();

      // 移除所有active类
      $('.sidebar-nav .nav-link').removeClass('active');
      // 添加active类到当前点击的链接
      $(this).addClass('active');

      // 获取目标界面ID
      const targetInterface = $(this).data('interface');
      showInterface(targetInterface);
    });

    // 条件选股表单提交
    $('#stock-filter-form').on('submit', function (e) {
      e.preventDefault();
      startStockFilter();
    });

    // 重置筛选条件
    $('#reset-filters').on('click', function () {
      $('#stock-filter-form')[0].reset();
    });

    // 预览策略
    $('#preview-strategy').on('click', function () {
      previewStrategy();
    });

    // 保存策略
    $('#save-strategy-btn').on('click', function () {
      saveStrategy();
    });

    // 加载策略
    $('#load-strategy-btn').on('click', function () {
      loadStrategy();
    });

    // AI选股开始
    $('#start-ai-select').on('click', function () {
      startAISelect();
    });

    // 清空历史
    $('#clear-history-btn').on('click', function () {
      clearHistory();
    });

    // 导出结果
    $('#export-results').on('click', function () {
      exportResults();
    });

    // 快速股票搜索
    $('#quick-stock-search').on('click', function () {
      const stockCode = $('#quick-stock-input').val().trim();
      if (stockCode) {
        loadStockDetail(stockCode);
      }
    });

    // 回车键搜索
    $('#quick-stock-input').on('keypress', function (e) {
      if (e.which === 13) {
        $('#quick-stock-search').click();
      }
    });

    // 刷新股票信息
    $('#refresh-stock-info').on('click', function () {
      if (selectedStock.code) {
        loadStockDetail(selectedStock.code);
      }
    });

    // 查看完整详情
    $('#view-full-detail').on('click', function () {
      if (selectedStock.code) {
        window.location.href = `/stock_detail/${selectedStock.code}`;
      }
    });

    // 添加到自选股
    $('#add-to-watchlist').on('click', function () {
      if (selectedStock.code) {
        addToPortfolio(selectedStock.code);
      }
    });

    // AI分析
    $('#start-ai-analysis').on('click', function () {
      if (selectedStock.code) {
        startAIStockAnalysis(selectedStock.code);
      }
    });
  });

  // 显示指定界面
  function showInterface(interfaceId) {
    console.log('切换界面到:', interfaceId);

    // 隐藏所有界面
    $('.interface-content').removeClass('active').hide();
    console.log('所有界面已隐藏');

    // 显示目标界面
    $('#' + interfaceId)
      .addClass('active')
      .show();
    console.log('目标界面已显示:', interfaceId);

    // 强制显示
    $('#' + interfaceId).css('display', 'block');
  }

  // 开始股票筛选
  function startStockFilter() {
    showLoading();

    // 收集筛选条件
    const filters = {
      market_type: $('#market-type').val(),
      industry_sector: $('#industry-sector').val(),
      rsi_filter: $('#rsi-filter').val(),
      macd_filter: $('#macd-filter').val(),
      volume_filter: $('#volume-filter').val(),
      pe_filter: $('#pe-filter').val(),
      pb_filter: $('#pb-filter').val(),
      roe_filter: $('#roe-filter').val(),
    };

    console.log('筛选条件:', filters);

    // 从数据库获取股票列表进行筛选
    $.ajax({
      url: '/api/stocks',
      type: 'GET',
      data: {
        market_type: filters.market_type,
        industry: filters.industry_sector,
        limit: 1000,
      },
      success: function (response) {
        hideLoading();
        if (response.success) {
          const stocks = response.data.stocks;
          console.log(`获取到 ${stocks.length} 只股票`);

          // 应用筛选条件
          const filteredStocks = applyFilters(stocks, filters);
          showFilterResults(filteredStocks);
        } else {
          showError('获取股票数据失败: ' + (response.message || '未知错误'));
        }
      },
      error: function (xhr, status, error) {
        hideLoading();
        showError('网络错误，无法获取股票数据');
        console.error('API调用失败:', error);
      },
    });
  }

  // 应用筛选条件到股票列表
  function applyFilters(stocks, filters) {
    let filteredStocks = [...stocks];

    // 行业筛选（已在API层面处理，这里做二次确认）
    if (filters.industry_sector) {
      filteredStocks = filteredStocks.filter(
        stock => stock.industry && stock.industry.includes(filters.industry_sector),
      );
    }

    // 市场类型筛选（已在API层面处理，这里做二次确认）
    if (filters.market_type) {
      filteredStocks = filteredStocks.filter(stock => stock.market_type === filters.market_type);
    }

    // 由于我们只有基础数据，其他技术指标筛选暂时使用模拟数据
    // 在实际项目中，这些数据应该从其他API获取
    console.log(`筛选后剩余 ${filteredStocks.length} 只股票`);

    // 为筛选结果添加模拟的技术指标数据
    return filteredStocks.map(stock => ({
      ...stock,
      price: generateMockPrice(),
      change: generateMockChange(),
      score: generateMockScore(),
      // 可以根据行业生成更合理的模拟数据
      industry: stock.industry || '未知',
    }));
  }

  // 生成模拟价格
  function generateMockPrice() {
    const prices = ['12.45', '18.76', '156.80', '45.23', '38.90', '25.60', '89.45', '67.23'];
    return prices[Math.floor(Math.random() * prices.length)];
  }

  // 生成模拟涨跌幅
  function generateMockChange() {
    const changes = ['+2.1%', '+1.8%', '+0.5%', '+1.2%', '-0.8%', '+3.2%', '-1.5%', '+0.9%'];
    return changes[Math.floor(Math.random() * changes.length)];
  }

  // 生成模拟评分
  function generateMockScore() {
    const scores = ['85', '78', '92', '88', '76', '91', '82', '87'];
    return scores[Math.floor(Math.random() * scores.length)];
  }

  // 生成模拟结果
  function generateMockResults() {
    const mockStocks = [
      {
        code: '000001',
        name: '平安银行',
        industry: '银行',
        price: '12.45',
        change: '+2.1%',
        score: '85',
      },
      {
        code: '000002',
        name: '万科A',
        industry: '房地产',
        price: '18.76',
        change: '+1.8%',
        score: '78',
      },
      {
        code: '000858',
        name: '五粮液',
        industry: '白酒',
        price: '156.80',
        change: '+0.5%',
        score: '92',
      },
      {
        code: '600036',
        name: '招商银行',
        industry: '银行',
        price: '45.23',
        change: '+1.2%',
        score: '88',
      },
      {
        code: '000858',
        name: '格力电器',
        industry: '家电',
        price: '38.90',
        change: '-0.8%',
        score: '76',
      },
    ];
    return mockStocks;
  }

  // 显示筛选结果
  function showFilterResults(stocks) {
    $('#result-count').text(stocks.length);

    const tbody = $('#results-tbody');
    tbody.empty();

    stocks.forEach(stock => {
      const row = `
        <tr>
          <td><strong>${stock.code}</strong></td>
          <td>${stock.name}</td>
          <td>${stock.industry}</td>
          <td>${stock.price}</td>
          <td><span class="text-success">${stock.change}</span></td>
          <td><span class="badge bg-success">${stock.score}</span></td>
          <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="loadStockDetail('${stock.code}')">
                          <i class="fas fa-eye"></i>
                        </button>
            <button class="btn btn-sm btn-outline-success" onclick="addToPortfolio('${stock.code}')">
              <i class="fas fa-plus"></i>
            </button>
          </td>
        </tr>
      `;
      tbody.append(row);
    });

    $('#filter-results').show();
  }

  // 预览策略
  function previewStrategy() {
    const filters = {
      market_type: $('#market-type').val(),
      industry_sector: $('#industry-sector').val(),
      rsi_filter: $('#rsi-filter').val(),
      macd_filter: $('#macd-filter').val(),
      volume_filter: $('#volume-filter').val(),
      pe_filter: $('#pe-filter').val(),
      pb_filter: $('#pb-filter').val(),
      roe_filter: $('#roe-filter').val(),
    };

    let previewText = '策略预览：\n';
    if (filters.market_type) previewText += `市场：${filters.market_type}\n`;
    if (filters.industry_sector) previewText += `行业：${filters.industry_sector}\n`;
    if (filters.rsi_filter) previewText += `RSI：${filters.rsi_filter}\n`;
    if (filters.macd_filter) previewText += `MACD：${filters.macd_filter}\n`;
    if (filters.volume_filter) previewText += `成交量：${filters.volume_filter}\n`;
    if (filters.pe_filter) previewText += `PE：${filters.pe_filter}\n`;
    if (filters.pb_filter) previewText += `PB：${filters.pb_filter}\n`;
    if (filters.roe_filter) previewText += `ROE：${filters.roe_filter}\n`;

    alert(previewText);
  }

  // 保存策略
  function saveStrategy() {
    const strategyName = prompt('请输入策略名称：');
    if (strategyName) {
      showSuccess(`策略"${strategyName}"保存成功！`);
    }
  }

  // 加载策略
  function loadStrategy() {
    showInfo('加载策略功能开发中...');
  }

  // 开始AI选股
  function startAISelect() {
    showLoading();
    setTimeout(() => {
      hideLoading();
      showSuccess('AI选股完成！推荐股票已生成。');
    }, 3000);
  }

  // 清空历史
  function clearHistory() {
    if (confirm('确定要清空所有历史记录吗？')) {
      showSuccess('历史记录已清空！');
    }
  }

  // 导出结果
  function exportResults() {
    showInfo('导出功能开发中...');
  }

  // 查看股票详情
  function viewStockDetail(code) {
    window.location.href = `/stock_detail/${code}`;
  }

  // 添加到投资组合
  function addToPortfolio(code) {
    showSuccess(`已将 ${code} 添加到自选股`);
  }

  // 加载股票详情
  function loadStockDetail(stockCode) {
    if (!stockCode) return;

    showLoading();

    // 模拟API调用获取股票详情
    setTimeout(() => {
      hideLoading();

      // 生成模拟数据
      const stockDetail = generateMockStockDetail(stockCode);

      // 更新选中的股票信息
      selectedStock = {
        code: stockCode,
        name: stockDetail.name,
        market_type: 'A',
      };

      // 显示股票详情
      showStockDetail(stockDetail);
    }, 1500);
  }

  // 生成模拟股票详情数据
  function generateMockStockDetail(stockCode) {
    const mockData = {
      '000001': {
        name: '平安银行',
        price: '12.45',
        change: '+0.26',
        changePercent: '+2.14%',
        rsi: '65.2',
        macd: '0.023',
        kdj: '78.5',
        volume: '1.2亿',
        pe: '8.5',
        pb: '0.8',
        roe: '12.5%',
        marketCap: '2,415亿',
        support: '12.20',
        resistance: '12.80',
      },
      '000002': {
        name: '万科A',
        price: '18.76',
        change: '+0.33',
        changePercent: '+1.79%',
        rsi: '58.7',
        macd: '-0.015',
        kdj: '62.3',
        volume: '8900万',
        pe: '12.3',
        pb: '1.2',
        roe: '15.2%',
        marketCap: '1,856亿',
        support: '18.50',
        resistance: '19.20',
      },
      '000858': {
        name: '五粮液',
        price: '156.80',
        change: '+0.78',
        changePercent: '+0.50%',
        rsi: '72.1',
        macd: '0.045',
        kdj: '85.2',
        volume: '3200万',
        pe: '25.6',
        pb: '8.9',
        roe: '22.1%',
        marketCap: '6,089亿',
        support: '155.00',
        resistance: '158.50',
      },
    };

    return (
      mockData[stockCode] || {
        name: `股票${stockCode}`,
        price: '0.00',
        change: '0.00',
        changePercent: '0.00%',
        rsi: '--',
        macd: '--',
        kdj: '--',
        volume: '--',
        pe: '--',
        pb: '--',
        roe: '--',
        marketCap: '--',
        support: '--',
        resistance: '--',
      }
    );
  }

  // 显示股票详情
  function showStockDetail(stockDetail) {
    // 隐藏默认面板，显示详情内容
    $('#default-stock-panel').hide();
    $('#stock-detail-content').show();

    // 更新基本信息
    $('#detail-stock-name').text(stockDetail.name);
    $('#detail-stock-code').text(selectedStock.code);
    $('#detail-stock-price').text(`¥${stockDetail.price}`);

    // 更新涨跌幅
    const isPositive = stockDetail.change.startsWith('+');
    $('#detail-stock-change')
      .text(stockDetail.change)
      .removeClass('text-success text-danger')
      .addClass(isPositive ? 'text-success' : 'text-danger');
    $('#detail-stock-change-percent')
      .text(stockDetail.changePercent)
      .removeClass('text-success text-danger')
      .addClass(isPositive ? 'text-success' : 'text-danger');

    // 更新技术指标
    $('#detail-rsi').text(stockDetail.rsi);
    $('#detail-macd').text(stockDetail.macd);
    $('#detail-kdj').text(stockDetail.kdj);
    $('#detail-volume').text(stockDetail.volume);

    // 更新基本面数据
    $('#detail-pe').text(stockDetail.pe);
    $('#detail-pb').text(stockDetail.pb);
    $('#detail-roe').text(stockDetail.roe);
    $('#detail-market-cap').text(stockDetail.marketCap);

    // 更新支撑压力位
    $('#detail-support').text(stockDetail.support);
    $('#detail-resistance').text(stockDetail.resistance);
  }

  // 开始AI股票分析
  function startAIStockAnalysis(stockCode) {
    showLoading();
    setTimeout(() => {
      hideLoading();
      showSuccess('AI分析完成！分析报告已生成。');
    }, 3000);
  }

  // 显示加载状态
  function showLoading() {
    $('#loading-panel').show();
  }

  // 隐藏加载状态
  function hideLoading() {
    $('#loading-panel').hide();
  }

  // 显示成功消息
  function showSuccess(message) {
    const alertHtml = `
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    $('#alerts-container').html(alertHtml);
  }

  // 显示信息消息
  function showInfo(message) {
    const alertHtml = `
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    $('#alerts-container').html(alertHtml);
  }

  // 显示错误消息
  function showError(message) {
    const alertHtml = `
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
    $('#alerts-container').html(alertHtml);
  }

  // 问题表单提交
  $('#question-form').submit(function (e) {
    e.preventDefault();
    const question = $('#question-input').val().trim();

    if (!question) {
      return;
    }
    history;

    if (!selectedStock.code) {
      showError('请先选择一只股票');
      return;
    }

    addUserMessage(question);
    $('#question-input').val('');
    askQuestion(question);
  });

  // 常见问题点击
  $('.common-question').click(function () {
    const question = $(this).data('question');

    if (!selectedStock.code) {
      showError('请先选择一只股票');
      return;
    }

    $('#question-input').val(question);
    $('#question-form').submit();
    history;
  });

  function selectStock(stockCode, marketType) {
    $('#loading-panel').show();
    $('#chat-container').hide();

    // 重置对话区域
    $('#chat-messages').html(`
            <div class="chat-message system-message">
                <div class="message-content">
                    <p>您好！我是股票分析AI助手，请输入您想了解的关于当前股票的问题。</p>
                </div>
            </div>
        `);

    // 获取股票基本信息
    $.ajax({
      url: '/analyze',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        stock_codes: [stockCode],
        market_type: marketType,
      }),
      success: function (response) {
        $('#loading-panel').hide();

        if (response.results && response.results.length > 0) {
          const stockInfo = response.results[0];

          // 保存选中的股票信息
          selectedStock = {
            code: stockCode,
            name: stockInfo.stock_name || '未知',
            market_type: marketType,
            industry: stockInfo.industry || '未知',
            price: stockInfo.price || 0,
            price_change: stockInfo.price_change || 0,
          };

          // 更新股票信息区域
          updateStockInfo();

          // 显示聊天界面
          $('#chat-container').show();

          // 欢迎消息
          addSystemMessage(
            `我已加载 ${selectedStock.name}(${selectedStock.code}) 的数据，您可以问我关于这只股票的问题。`,
          );
        } else {
          showError('未找到股票信息，请检查股票代码是否正确');
        }
      },
      error: function (xhr, status, error) {
        $('#loading-panel').hide();
        let errorMsg = '获取股票信息失败';
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg += ': ' + xhr.responseJSON.error;
        } else if (error) {
          errorMsg += ': ' + error;
        }
        showError(errorMsg);
      },
    });
  }

  function updateStockInfo() {
    // 更新股票信息区域
    $('#stock-info-header').text(selectedStock.name);
    $('#selected-stock-name').text(selectedStock.name);
    $('#selected-stock-code').text(selectedStock.code);
    $('#selected-stock-industry').text(selectedStock.industry);
    $('#selected-stock-price').text('¥' + formatNumber(selectedStock.price, 2));

    const priceChangeClass = selectedStock.price_change >= 0 ? 'trend-up' : 'trend-down';
    const priceChangeIcon =
      selectedStock.price_change >= 0 ? '<i class="fas fa-caret-up"></i> ' : '<i class="fas fa-caret-down"></i> ';
    $('#selected-stock-change').html(
      `<span class="${priceChangeClass}">${priceChangeIcon}${formatPercent(selectedStock.price_change, 2)}</span>`,
    );
  }

  function askQuestion(question) {
    // 显示思考中消息
    const thinkingMessageId = 'thinking-' + Date.now();
    addSystemMessage('<i class="fas fa-spinner fa-pulse"></i> 正在思考...', thinkingMessageId);

    // 发送问题到API
    $.ajax({
      url: '/api/qa',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({
        stock_code: selectedStock.code,
        question: question,
        market_type: selectedStock.market_type,
      }),
      success: function (response) {
        // 移除思考中消息
        $(`#${thinkingMessageId}`).remove();

        // 添加回答
        addSystemMessage(formatAnswer(response.answer));

        // 滚动到底部
        scrollToBottom();
      },
      error: function (xhr, status, error) {
        // 移除思考中消息
        $(`#${thinkingMessageId}`).remove();

        // 添加错误消息
        let errorMsg = '无法回答您的问题';
        if (xhr.responseJSON && xhr.responseJSON.error) {
          errorMsg += ': ' + xhr.responseJSON.error;
        } else if (error) {
          errorMsg += ': ' + error;
        }

        addSystemMessage(`<span class="text-danger">${errorMsg}</span>`);

        // 滚动到底部
        scrollToBottom();
      },
    });
  }

  function addUserMessage(message) {
    const time = new Date().toLocaleTimeString();

    const messageHtml = `
            <div class="chat-message user-message">
                <div class="message-content">
                    <p>${message}</p>
                </div>
                <div class="message-time">${time}</div>
            </div>
        `;

    $('#chat-messages').append(messageHtml);
    scrollToBottom();
  }

  function addSystemMessage(message, id = null) {
    const time = new Date().toLocaleTimeString();
    const idAttribute = id ? `id="${id}"` : '';

    const messageHtml = `
            <div class="chat-message system-message" ${idAttribute}>
                <div class="message-content">
                    <p>${message}</p>
                </div>
                <div class="message-time">${time}</div>
            </div>
        `;

    $('#chat-messages').append(messageHtml);
    scrollToBottom();
  }

  function scrollToBottom() {
    const chatContainer = document.getElementById('chat-messages');
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function formatAnswer(text) {
    if (!text) return '';

    // First, make the text safe for HTML
    const safeText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Replace basic Markdown elements
    let formatted = safeText
      // Bold text with ** or __
      .replace(/\*\*(.*?)\*\*/g, '<strong class="keyword">$1</strong>')
      .replace(/__(.*?)__/g, '<strong>$1</strong>')

      // Italic text with * or _
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/_(.*?)_/g, '<em>$1</em>')

      // Headers - only h4, h5, h6 for chat
      .replace(/^#### (.*?)$/gm, '<h6>$1</h6>')
      .replace(/^### (.*?)$/gm, '<h6>$1</h6>')
      .replace(/^## (.*?)$/gm, '<h6>$1</h6>')
      .replace(/^# (.*?)$/gm, '<h6>$1</h6>')

      // Apply special styling to financial terms
      .replace(/支撑位/g, '<span class="keyword">支撑位</span>')
      .replace(/压力位/g, '<span class="keyword">压力位</span>')
      .replace(/趋势/g, '<span class="keyword">趋势</span>')
      .replace(/均线/g, '<span class="keyword">均线</span>')
      .replace(/MACD/g, '<span class="term">MACD</span>')
      .replace(/RSI/g, '<span class="term">RSI</span>')
      .replace(/KDJ/g, '<span class="term">KDJ</span>')

      // Highlight price patterns and movements
      .replace(/([上涨升])/g, '<span class="trend-up">$1</span>')
      .replace(/([下跌降])/g, '<span class="trend-down">$1</span>')
      .replace(/(买入|做多|多头|突破)/g, '<span class="trend-up">$1</span>')
      .replace(/(卖出|做空|空头|跌破)/g, '<span class="trend-down">$1</span>')

      // Highlight price values (matches patterns like 31.25, 120.50)
      .replace(/(\d+\.\d{2})/g, '<span class="price">$1</span>')

      // Convert line breaks to paragraph tags
      .replace(/\n\n+/g, '</p><p class="mb-2">')
      .replace(/\n/g, '<br>');

    // Wrap in paragraph tags for consistent styling
    return '<p class="mb-2">' + formatted + '</p>';
  }

  // 数据状态检查和手动下载功能
  function checkStockDataStatus() {
    $.ajax({
      url: '/api/stock_download_status',
      type: 'GET',
      success: function (response) {
        if (response.success) {
          const data = response.data;
          updateDataStatusDisplay(data);
        } else {
          showDataStatusError('获取数据状态失败');
        }
      },
      error: function () {
        showDataStatusError('网络错误，无法获取数据状态');
      },
    });
  }

  function updateDataStatusDisplay(data) {
    const statusElement = $('#stock-data-status');
    const downloadBtn = $('#manual-download-btn');

    if (data.has_data) {
      statusElement.removeClass('bg-info bg-warning bg-danger').addClass('bg-success');
      statusElement.html(`<i class="fas fa-database"></i> 股票数据: ${data.stock_count} 只`);
      downloadBtn.hide();

      // 更新数据获取时间
      updateDataUpdateTime(data.last_update);
    } else {
      statusElement.removeClass('bg-info bg-success bg-danger').addClass('bg-warning');
      statusElement.html(`<i class="fas fa-exclamation-triangle"></i> 无股票数据`);
      downloadBtn.show();
    }

    if (data.is_downloading) {
      statusElement.removeClass('bg-success bg-warning bg-danger').addClass('bg-info');
      statusElement.html(`<i class="fas fa-spinner fa-spin"></i> 正在下载数据...`);
      downloadBtn.hide();
    }
  }

  function showDataStatusError(message) {
    const statusElement = $('#stock-data-status');
    statusElement.removeClass('bg-info bg-success bg-warning').addClass('bg-danger');
    statusElement.html(`<i class="fas fa-exclamation-circle"></i> ${message}`);
  }

  function manualDownloadStockData() {
    if (confirm('确定要手动下载股票数据吗？这可能需要几分钟时间。')) {
      const downloadBtn = $('#manual-download-btn');
      const originalText = downloadBtn.html();

      // 更新按钮状态
      downloadBtn.prop('disabled', true);
      downloadBtn.html('<i class="fas fa-spinner fa-spin"></i> 下载中...');

      $.ajax({
        url: '/api/download_stock_info',
        type: 'POST',
        success: function (response) {
          if (response.success) {
            showSuccess('股票数据下载任务已启动，请稍后查看状态');
            // 开始轮询状态
            startStatusPolling();
          } else {
            showError(response.message || '下载失败');
            resetDownloadButton(downloadBtn, originalText);
          }
        },
        error: function (xhr) {
          let errorMsg = '下载失败';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMsg = xhr.responseJSON.message;
          }
          showError(errorMsg);
          resetDownloadButton(downloadBtn, originalText);
        },
      });
    }
  }

  function resetDownloadButton(btn, text) {
    btn.prop('disabled', false);
    btn.html(text);
  }

  function startStatusPolling() {
    // 每5秒检查一次状态
    const pollInterval = setInterval(function () {
      $.ajax({
        url: '/api/stock_download_status',
        type: 'GET',
        success: function (response) {
          if (response.success) {
            const data = response.data;
            updateDataStatusDisplay(data);

            // 如果下载完成，停止轮询
            if (!data.is_downloading) {
              clearInterval(pollInterval);
              if (data.has_data) {
                showSuccess('股票数据下载完成！');
              }
            }
          }
        },
        error: function () {
          // 轮询失败时停止
          clearInterval(pollInterval);
        },
      });
    }, 5000);
  }

  // 强制获取新数据
  function forceRefreshData() {
    if (confirm('确定要强制获取最新的股票数据吗？这将覆盖现有数据，可能需要几分钟时间。')) {
      const refreshBtn = $('#force-refresh-data-btn');
      const originalText = refreshBtn.html();

      // 更新按钮状态
      refreshBtn.prop('disabled', true);
      refreshBtn.html('<i class="fas fa-spinner fa-spin"></i> 获取中...');

      // 显示进度条
      showProgressBar();

      $.ajax({
        url: '/api/download_stock_info',
        type: 'POST',
        success: function (response) {
          if (response.success) {
            showSuccess('强制获取新数据任务已启动，请稍后查看状态');
            // 开始轮询状态，显示进度
            startForceRefreshPolling();
          } else {
            showError(response.message || '强制获取失败');
            resetRefreshButton(refreshBtn, originalText);
            hideProgressBar();
          }
        },
        error: function (xhr) {
          let errorMsg = '强制获取失败';
          if (xhr.responseJSON && xhr.responseJSON.message) {
            errorMsg = xhr.responseJSON.message;
          }
          showError(errorMsg);
          resetRefreshButton(refreshBtn, originalText);
          hideProgressBar();
        },
      });
    }
  }

  // 重置强制获取按钮
  function resetRefreshButton(btn, text) {
    btn.prop('disabled', false);
    btn.html(text);
  }

  // 显示进度条
  function showProgressBar() {
    // 创建进度条HTML
    const progressHtml = `
      <div id="force-refresh-progress" class="mt-3">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" 
               role="progressbar" 
               style="width: 0%" 
               aria-valuenow="0" 
               aria-valuemin="0" 
               aria-valuemax="100">
            准备中...
          </div>
        </div>
        <div class="text-center mt-2">
          <small class="text-muted" id="progress-text">正在准备获取最新数据...</small>
        </div>
        <div class="text-center mt-1">
          <small class="text-muted" id="progress-stock">...</small>
        </div>
        <div class="text-center mt-1">
          <small class="text-info" id="progress-count">0/0</small>
        </div>
      </div>
    `;

    // 在筛选结果表格前插入进度条
    $('#filter-results').before(progressHtml);

    // 不再使用模拟进度，而是使用实际进度
    // simulateProgress();
  }

  // 隐藏进度条
  function hideProgressBar() {
    $('#force-refresh-progress').remove();
  }

  // 模拟进度更新
  function simulateProgress() {
    let progress = 0;
    const progressBar = $('#force-refresh-progress .progress-bar');
    const progressText = $('#progress-text');

    const interval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90; // 最多到90%，等待实际完成

      progressBar.css('width', progress + '%').attr('aria-valuenow', progress);

      if (progress < 30) {
        progressText.text('正在连接数据源...');
      } else if (progress < 60) {
        progressText.text('正在下载股票列表...');
      } else if (progress < 90) {
        progressText.text('正在更新数据库...');
      }

      if (progress >= 90) {
        clearInterval(interval);
      }
    }, 500);
  }

  // 强制获取新数据的轮询
  function startForceRefreshPolling() {
    const progressBar = $('#force-refresh-progress .progress-bar');
    const progressText = $('#progress-text');
    const progressStock = $('#progress-stock');
    const progressCount = $('#progress-count');

    // 每1秒检查一次状态，提高实时性
    const pollInterval = setInterval(function () {
      $.ajax({
        url: '/api/stock_download_status',
        type: 'GET',
        success: function (response) {
          if (response.success) {
            const data = response.data;
            updateDataStatusDisplay(data);

            // 更新进度条
            if (data.is_downloading && data.download_progress) {
              const progress = data.download_progress;
              
              // 设置进度百分比
              const percent = progress.percent || 0;
              progressBar.css('width', percent + '%').attr('aria-valuenow', percent);
              progressBar.text(`${percent}%`);
              
              // 设置当前处理的股票
              if (progress.current_stock) {
                progressStock.text(`当前处理: ${progress.current_stock}`);
              } else {
                progressStock.text('准备中...');
              }
              
              // 设置进度计数
              if (progress.total > 0) {
                progressCount.text(`${progress.current}/${progress.total} (${percent}%)`);
                
                // 根据进度设置不同的状态文本
                if (percent < 10) {
                  progressText.text('正在获取股票列表...');
                } else if (percent < 50) {
                  progressText.text('正在下载股票基本信息...');
                } else if (percent < 80) {
                  progressText.text('正在获取股票实时行情...');
                } else {
                  progressText.text('正在更新数据库...');
                }
              }
            } else if (!data.is_downloading) {
              // 下载完成
              progressBar.css('width', '100%').attr('aria-valuenow', 100);
              progressBar.text('100%');
              progressText.text('数据更新完成！');
              progressStock.text('全部完成');

              // 更新数据获取时间
              updateDataUpdateTime(data.last_update);

              // 停止轮询
              clearInterval(pollInterval);

              // 延迟隐藏进度条
              setTimeout(() => {
                hideProgressBar();
                showSuccess('股票数据已成功更新！');
                
                // 重置按钮状态
                $('#force-refresh-data-btn').prop('disabled', false).html('<i class="fas fa-sync-alt"></i> 强制获取新数据');
              }, 2000);
            }
          }
        },
        error: function () {
          // 轮询失败时停止
          clearInterval(pollInterval);
          hideProgressBar();
          
          // 重置按钮状态
          $('#force-refresh-data-btn').prop('disabled', false).html('<i class="fas fa-sync-alt"></i> 强制获取新数据');
        },
      });
    }, 2000);
  }

  // 更新数据获取时间显示
  function updateDataUpdateTime(lastUpdate) {
    if (lastUpdate) {
      $('#data-update-time').text(lastUpdate);
    }
  }

  // 页面加载完成后检查数据状态
  $(document).ready(function () {
    // 检查股票数据状态
    checkStockDataStatus();

    // 绑定手动下载按钮事件
    $('#manual-download-btn').on('click', manualDownloadStockData);

    // 绑定强制获取新数据按钮事件
    $('#force-refresh-data-btn').on('click', forceRefreshData);
  });
</script>
{% endblock %}
